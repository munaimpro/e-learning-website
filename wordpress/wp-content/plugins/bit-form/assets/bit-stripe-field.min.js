var bit_stripe_field=function(){"use strict";return class{#e="";#t="";#s=null;#i=null;#n=null;#r={};#a=null;#l=null;#o=null;#d=null;#h=null;#c=null;#p=null;#u=null;#y=null;#m=null;#f=null;#g=null;#b=null;#S=null;#I=null;#v=[];#V=null;#E=null;#L=null;constructor(e,t){this.#e="string"==typeof e?document.querySelector(e):e,Object.assign(this.#r,t),this.#t=this.#r.publishableKey,this.#s=this.#r.options,this.#i=this.#r.contentId,this.#a=this.#r.payIntegID,this.#l=this.#r.fieldKey,this.#c=this.#r?.amountFld,this.#p=this.#r?.amount,this.#h=this.#r.amountType,this.#u=this.#r.options.currency,this.#y=`#form-${this.#i}`,this.#m=this.#i?.split("_")[1],this.#b=this.#r.theme.style,this.#S=this.#r.layout,this.#I=this.#r.payBtnTxt,this.#V=this.#r.options?.description,this.#E=this.#r?.address||{},this.init()}init(){this.#L=this.#w(`.${this.#l}-stripe-btn`),this.#D()}#w(e){return document.querySelector(this.#y).querySelector(e)}#D(){this.#f=this.#w(".stripe-btn-spinner"),this.#K(this.#L,"click",(()=>{this.#L.disabled=!0,this.#f.classList.remove("d-none"),this.#_(this.#i).then((e=>{e&&this.#T()})).finally((()=>this.#f.classList.add("d-none")))}))}#K(e,t,s){e.addEventListener(t,s),this.#v.push({selector:e,eventType:t,cb:s})}#$(){if(this.#E){this.#E.defaultValues?.address||(this.#E.defaultValues.address={});const{address:e}=this.#E.defaultValues,t={line1:"",line2:"",city:"",state:"",postal_code:"",country:""};return Object.keys(e).map((s=>{t[s]=this.#x(e[s])})),t}}#x(e){if(e){const t=window.bf_globals[this.#i].fields[e]?.fieldName;if(!t)return;let s=this.#w(`[name="${t}"]`,this.#y);if(s&&"radio"===s.type&&(s=this.#w(`[name="${t}"]:checked`,this.#y)),s&&s.value)return s.value}return""}#B(e=""){const t=bfSelect(`${this.#y} .${this.#l}-err-wrp`),s=bfSelect(`.${this.#l}-err-txt`,t),i=bfSelect(`.${this.#l}-err-msg`,t);if(e){i.style.removeProperty("display"),s.innerHTML=e,setStyleProperty(t,"height",`${s.parentElement.scrollHeight}px`),setStyleProperty(t,"opacity",1);const n=this.#w(`${this.#y} .btcd-fld-itm.${this.#l}`);scrollToElm(n)}else s.innerHTML="",setStyleProperty(i,"display","none"),setStyleProperty(t,"height",0),setStyleProperty(t,"opacity",0)}#T(){const{Stripe:e}=window,t=this.#x(this.#c);if("dynamic"===this.#h&&!t)return void this.#B("Amount field is required");this.#B();const s=100*("fixed"===this.#h?this.#p:t);if(e){this.#d=e(this.#t);const t={payIntegID:this.#a,amount:s,currency:this.#u,metadata:{formID:this.#m,entryID:this.#n,fieldKey:this.#l},payment_method_types:this.#s.payment_method_types,description:this.#V};if("shipping"===this.#E?.mode){if("shipping"in t||(t.shipping={}),"full"===this.#E.display.name)t.shipping.name=this.#x(this.#E.defaultValues.name);else{const e=`${this.#x(this.#E.defaultValues.firstName)} ${this.#x(this.#E.defaultValues.lastName)}`;t.shipping.name=e}this.#E.defaultValues.phone&&(t.shipping.phone=this.#x(this.#E.defaultValues.phone)),t.shipping.address=this.#$()}bitsFetchFront(this.#i,t,"bitforms_get_stripe_secret_key").then((e=>{const{success:t,data:s}=e;if(!t)return void this.#B(s.error.message);this.#B(),this.#e.classList.remove("d-none");const{clientSecret:i}=s,n={appearance:this.#b,clientSecret:i,locale:this.#s.locale};if(this.#o=this.#d.elements(n),this.#g=this.#o.create("payment",{layout:this.#S}),this.#r?.linkAuthentication?.active){const e=this.#x(this.#r.linkAuthentication.emailFld),t=this.#o.create("linkAuthentication",{defaultValues:{email:e}}),s=this.#w(`${this.#y} .${this.#l}-stripe-auth-wrp`);t.mount(s)}if(this.#E.active&&"billing"===this.#E.mode){const{address:e}=this.#r;"full"===this.#E.display.name?e.defaultValues.name=this.#x(this.#E.defaultValues.name):(e.defaultValues.firstName=this.#x(this.#E.defaultValues.firstName),e.defaultValues.lastName=this.#x(this.#E.defaultValues.lastName)),this.#E.defaultValues.phone&&(e.defaultValues.phone=this.#x(this.#E.defaultValues.phone)),e.defaultValues.address=this.#$();const t=this.#o.create("address",e),s=this.#w(`${this.#y} .${this.#l}-stripe-addr-wrp`);t.mount(s)}this.#g.mount(this.#e),this.#f.classList.add("d-none")})).then((()=>{const e=document.createElement("button");e.innerText=this.#I,e.classList.add("stripe-pay-btn"),e.setAttribute("id","pay-now-btn"),e.setAttribute("type","button");const t=document.createElement("span");t.innerHTML='\n                <svg width="25" height="25" class="pay-spinner d-none" version="1.1" id="L9" xmlns="http://www.w3.org/2000/svg"\n                xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 0 0"\n                xml:space="preserve">\n                <path fill="#fff"\n                  d="M73,50c0-12.7-10.3-23-23-23S27,37.3,27,50 M30.9,50c0-10.5,8.5-19.1,19.1-19.1S69.1,39.5,69.1,50">\n                  <animateTransform attributeName="transform" attributeType="XML" type="rotate" dur="1s" from="0 50 50"\n                    to="360 50 50" repeatCount="indefinite" />\n                </path>\n              </svg>',e.insertAdjacentElement("beforeend",t),this.#e.insertAdjacentElement("beforeend",e),this.#q()}))}}#q(){const e=this.#w("#pay-now-btn"),t=this.#o;this.#K(e,"click",(()=>{e.disabled=!0;const s=this.#w(".pay-spinner");s.classList.remove("d-none"),this.#d.confirmPayment({elements:t,confirmParams:{},redirect:"if_required"}).then((e=>{if("succeeded"===e?.paymentIntent?.status)s.classList.add("d-none"),this.#P(e.paymentIntent),this.#g.clear();else{const t={data:{[this.#l]:e.error.message}};bfValidationErrMsg(t,this.#i),s.classList.add("d-none")}})).finally((()=>{s.classList.add("d-none"),e.disabled=!1,this.#L.disabled=!1}))}))}async#_(e){try{await isFormValidatedWithoutError(e)}catch(e){return this.#L.disabled=!1,Promise.reject()}const t=await saveFormProgress(e),s=t?.[e];return s?.success?(s.success&&(this.#n=s.data.entry_id),Promise.resolve(!0)):Promise.reject()}#P(e){const t=document.getElementById(`${this.#i}`);t.classList.add("pos-rel","form-loading");const s=document.getElementById(`form-${this.#i}`);if(null!=s){const i=bf_globals[this.#i];this.#n&&(i.entryId=this.#n);const n=bfSelect(`input[name="${this.#r.fieldKey}"]`,s);n?n.value=e.id:setHiddenFld({name:this.#r.fieldKey,value:e.id,type:"text"},s);let r=bfSelect('button[type="submit"]',s);r||(r=document.createElement("button"),r.setAttribute("type","submit"),r.style.display="none",s.append(r)),r.click();const a={formID:this.#m,transactionID:e.id,payment_name:"stripe",payment_type:"order",payment_response:e,entry_id:this.#n,fieldKey:this.#l},l=new URL(i?.ajaxURL);l.searchParams.append("_ajax_nonce",i?.nonce),l.searchParams.append("action","bitforms_payment_insert"),fetch(l,{method:"POST",body:JSON.stringify(a)}).then((()=>{t.classList.remove("pos-rel","form-loading"),this.#n=null}))}}#A(){this.#v.forEach((({selector:e,eventType:t,cb:s})=>{e.removeEventListener(t,s)}))}destroy(){this.#g?.destroy();const e=this.#w(`.${this.#l}-stripe-fld`),t=this.#w(`.${this.#l}-stripe-auth-wrp`),s=this.#w(`.${this.#l}-stripe-addr-wrp`);e.classList.add("d-none"),e.innerHTML="",this.#e.innerHTML="",this.#L.disabled=!1,t&&(t.innerHTML=""),s&&(s.innerHTML=""),this.#A()}reset(){this.destroy(),this.init()}}}();
